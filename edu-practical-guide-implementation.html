<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EDU Practical Guide â€” Implementation</title>
  <style>
    :root {
      --max-w: 1440px;
    }
    html, body { margin: 0; padding: 0; background:transparent; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:#111; }
    .page { display:flex; justify-content:center; padding:0; }
    .container { position:relative; width:100%; max-width: var(--max-w); background:#F0F0F0; border-radius:8px; box-shadow:0 10px 40px rgba(0,0,0,0.25); }

    .component { display:none; position:relative; background:#F0F0F0; }
    .component.active { display:block; }

    .svg-host { position:relative; width:100%; height:auto; display:block; background:#F0F0F0; }
    .svg-host img { width:100%; height:auto; display:block; }

    /* overlay root sits above the image in the svg-host */
    .overlay-root { position:absolute; top:0; left:0; right:0; bottom:0; pointer-events:none; z-index:10; }
    .click-area { position:absolute; border-radius:8px; pointer-events:auto; cursor:pointer; }
    .click-area.debug { outline: 2px dashed rgba(191,224,2,0.8); background: rgba(191,224,2,0.15); }
    
    /* Debug toggle button */
    .debug-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 9999;
      padding: 12px 20px;
      background: #7E0EB3;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      transition: all 0.2s;
    }
    .debug-toggle:hover {
      background: #6A0B99;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.4);
    }
    .debug-toggle.active {
      background: #BFE002;
      color: #252D36;
    }
    
    /* Coordinate display */
    .coord-display {
      position: fixed;
      bottom: 70px;
      right: 20px;
      z-index: 9999;
      padding: 8px 12px;
      background: rgba(37, 45, 54, 0.95);
      color: #BFE002;
      border-radius: 6px;
      font-family: monospace;
      font-size: 12px;
      pointer-events: none;
      display: none;
    }
    .coord-display.active {
      display: block;
    }
  </style>
</head>
<body>
  <input id="debugToggle" type="checkbox" style="display:none;" />
  <button class="debug-toggle" id="debugButton">Show Click Areas</button>
  <div class="coord-display" id="coordDisplay">Click on slide to see coordinates</div>

  <div class="page">
    <div class="container">
      <!-- components injected here by JS -->
    </div>
  </div>

  <script>
    /**
     * Helper: create a component block that embeds an external SVG via <img>,
     * then positions overlays using percent based on the SVG's viewBox.
     */

    // No progress bar navigation - only Back/Next buttons

    const components = [
      // Slide 1 - Practical Exercises
      {
        id: 1,
        file: "EDU Practical Guide (Implementation)/1 - Practical Exercises.svg",
        viewBoxWidth: 1440,
        viewBoxHeight: 1249,
        overlays: [
          { action: "next", x: 1293, y: 80, w: 50, h: 50 },
          { action: "next", x: 1173, y: 1133, w: 207, h: 56 }
        ]
      },
      // Slide 2 - Compare Tools vs. to NCC AS
      {
        id: 2,
        file: "EDU Practical Guide (Implementation)/2 - Compare Tools vs. to NCC AS.svg",
        viewBoxWidth: 1440,
        viewBoxHeight: 1003,
        overlays: [
          { action: "back", x: 101, y: 80, w: 50, h: 50 },
          { action: "next", x: 1293, y: 80, w: 50, h: 50 },
          { action: "url", url: "https://buildingtools.co/r/QanA9p?click=t&type=1", x: 176.734, y: 585, w: 148.61, h: 24 },
          { action: "url", url: "https://ncc.abcb.gov.au/editions/ncc-2022/adopted/housing-provisions/11-safe-movement-and-access/part-112-stairway-and-ramp-construction", x: 366.359, y: 661, w: 196.633, h: 24 },
          { action: "back", x: 60, y: 823, w: 142, h: 56 },
          { action: "next", x: 1199, y: 823, w: 181, h: 56 }
        ]
      },
      // Slide 3 - Foundational Tools for Education (with Accordions)
      {
        id: 3,
        file: "EDU Practical Guide (Implementation)/3 - Foundational Tools for Education.svg",
        viewBoxWidth: 1440,
        viewBoxHeight: 6092,
        accordions: [
          { id: 'acc1', collapsed: "EDU Practical Guide (Implementation)/Accordion/1 - Construction Basics Collapsed.svg", expanded: "EDU Practical Guide (Implementation)/Accordion/1 - Construction Basics Open.svg", y: 170, hC: 62, hE: 417,
            links: [
              { url: "https://buildingtools.co/r/O8KA6i?click=t&type=0", x: 8, y: 77, w: 122.742, h: 18.3984 },
              { url: "https://buildingtools.co/r/O8KA6i?click=t&type=0", x: 443, y: 77, w: 122.742, h: 18.3984 },
              { url: "https://buildingtools.co/r/O8KA6i?click=t&type=0", x: 878, y: 77, w: 122.742, h: 18.3984 }
            ]
          },
          { id: 'acc2', collapsed: "EDU Practical Guide (Implementation)/Accordion/2 - Science of Construction Quality Collapsed.svg", expanded: "EDU Practical Guide (Implementation)/Accordion/2 - Science of Construction Quality Open.svg", y: 242, hC: 62, hE: 417,
            links: [
              { url: "https://buildingtools.co/r/O8KA6i?click=t&type=0", x: 8, y: 67, w: 122.742, h: 18.3984 },
              { url: "https://buildingtools.co/r/O8KA6i?click=t&type=0", x: 443, y: 67, w: 122.742, h: 18.3984 }
            ]
          },
          { id: 'acc3', collapsed: "EDU Practical Guide (Implementation)/Accordion/3 - Design Fundamentals Collapsed.svg", expanded: "EDU Practical Guide (Implementation)/Accordion/3 - Design Fundamentals Open.svg", y: 314, hC: 62, hE: 417,
            links: [
              { url: "https://buildingtools.co/r/O8KA6i?click=t&type=0", x: 8, y: 67, w: 122.742, h: 18.3984 },
              { url: "https://buildingtools.co/r/O8KA6i?click=t&type=0", x: 443, y: 67, w: 122.742, h: 18.3984 },
              { url: "https://buildingtools.co/r/O8KA6i?click=t&type=0", x: 878, y: 67, w: 122.742, h: 18.3984 },
              { url: "https://buildingtools.co/r/O8KA6i?click=t&type=0", x: 8, y: 259, w: 122.742, h: 18.3984 },
              { url: "https://buildingtools.co/r/O8KA6i?click=t&type=0", x: 443, y: 259, w: 122.742, h: 18.3984 }
            ]
          },
          { id: 'acc4', collapsed: "EDU Practical Guide (Implementation)/Accordion/4 - Plumbing Collapsed.svg", expanded: "EDU Practical Guide (Implementation)/Accordion/4 - Plumbing Open.svg", y: 386, hC: 62, hE: 417,
            links: [
              { url: "https://buildingtools.co/r/O8KA6i?click=t&type=0", x: 8, y: 67, w: 122.742, h: 18.3984 },
              { url: "https://buildingtools.co/r/O8KA6i?click=t&type=0", x: 443, y: 67, w: 122.742, h: 18.3984 },
              { url: "https://buildingtools.co/r/O8KA6i?click=t&type=0", x: 878, y: 67, w: 122.742, h: 18.3984 }
            ]
          },
          { id: 'acc5', collapsed: "EDU Practical Guide (Implementation)/Accordion/5 - Carpentry Collapsed.svg", expanded: "EDU Practical Guide (Implementation)/Accordion/5 - Carpentry Open.svg", y: 458, hC: 62, hE: 717,
            links: [
              { url: "https://buildingtools.co/r/O8KA6i?click=t&type=0", x: 8, y: 67, w: 122.742, h: 18.3984 },
              { url: "https://buildingtools.co/r/O8KA6i?click=t&type=0", x: 443, y: 67, w: 122.742, h: 18.3984 },
              { url: "https://buildingtools.co/r/O8KA6i?click=t&type=0", x: 878, y: 67, w: 122.742, h: 18.3984 },
              { url: "https://buildingtools.co/r/O8KA6i?click=t&type=0", x: 8, y: 259, w: 122.742, h: 18.3984 },
              { url: "https://buildingtools.co/r/O8KA6i?click=t&type=0", x: 177.5, y: 779.963, w: 122.742, h: 18.3984 },
              { url: "https://buildingtools.co/r/O8KA6i?click=t&type=0", x: 588, y: 591.112, w: 122.742, h: 18.3984 }
            ]
          },
          { id: 'acc6', collapsed: "EDU Practical Guide (Implementation)/Accordion/6 - Electrical Collapsed.svg", expanded: "EDU Practical Guide (Implementation)/Accordion/6 - Electrical Open.svg", y: 530, hC: 62, hE: 417,
            links: [
              { url: "https://buildingtools.co/r/O8KA6i?click=t&type=0", x: 8, y: 67, w: 122.742, h: 18.3984 },
              { url: "https://buildingtools.co/r/O8KA6i?click=t&type=0", x: 443, y: 67, w: 122.742, h: 18.3984 },
              { url: "https://buildingtools.co/r/O8KA6i?click=t&type=0", x: 878, y: 67, w: 122.742, h: 18.3984 }
            ]
          },
          { id: 'acc7', collapsed: "EDU Practical Guide (Implementation)/Accordion/7 - Waterproofing Collapsed.svg", expanded: "EDU Practical Guide (Implementation)/Accordion/7 - Waterproofing Open.svg", y: 602, hC: 62, hE: 417,
            links: [
              { url: "https://buildingtools.co/r/O8KA6i?click=t&type=0", x: 8, y: 67, w: 122.742, h: 18.3984 },
              { url: "https://buildingtools.co/r/O8KA6i?click=t&type=0", x: 443, y: 67, w: 122.742, h: 18.3984 },
              { url: "https://buildingtools.co/r/O8KA6i?click=t&type=0", x: 878, y: 67, w: 122.742, h: 18.3984 }
            ]
          }
        ],
        postAccordionImage: {
          file: "EDU Practical Guide (Implementation)/Frame 90.svg",
          width: 1281,
          height: 1784,
          overlays: [
            { action: "url", url: "#", x: 1214, y: 219.5, w: 166, h: 48 }, // Show me button
            { action: "back", x: 60, y: 2522, w: 142, h: 56 }, // Back button at bottom
            { action: "next", x: 1198, y: 2522, w: 182, h: 56 } // Next/Module 3 button
          ]
        },
      },
      // Slide 4 - Embed Tools into Current Lesson Plans
      {
        id: 4,
        file: "EDU Practical Guide (Implementation)/4 - Embed Tools into Current Lesson Plans.svg",
        viewBoxWidth: 1440,
        viewBoxHeight: 1020,
        overlays: [
          { action: "back", x: 101, y: 80, w: 50, h: 50 },
          { action: "next", x: 1293, y: 80, w: 50, h: 50 },
          { action: "back", x: 60, y: 904, w: 142, h: 56 },
          { action: "next", x: 1198, y: 904, w: 182, h: 56 }
        ]
      },
      // Slide 5 - Playlists
      {
        id: 5,
        file: "EDU Practical Guide (Implementation)/5 - Playlists.svg",
        viewBoxWidth: 1440,
        viewBoxHeight: 1042,
        overlays: [
          { action: "back", x: 101, y: 80, w: 50, h: 50 },
          { action: "next", x: 1293, y: 80, w: 50, h: 50 },
          { action: "gif", url: "EDU Practical Guide (Implementation)/GIF/image (9).gif", x: 748, y: 338, w: 632, h: 487 },
          { action: "back", x: 60, y: 926, w: 142, h: 56 },
          { action: "next", x: 1199, y: 926, w: 181, h: 56 }
        ]
      },
      // Slide 6 - Real Life vs. Code
      {
        id: 6,
        file: "EDU Practical Guide (Implementation)/6 - Real Life vs. Code.svg",
        viewBoxWidth: 1440,
        viewBoxHeight: 2323,
        overlays: [
          { action: "back", x: 101, y: 80, w: 50, h: 50 },
          { action: "next", x: 1293, y: 80, w: 50, h: 50 },
          { action: "url", url: "https://buildingtools.co/r/sEiPKa?click=t&type=0", x: 119.641, y: 442.905, w: 172.625, h: 20 },
          { action: "url", url: "https://buildingtools.co/r/eUxoLN?click=t&type=0", x: 119.641, y: 1003.189, w: 163.093, h: 20 },
          { action: "url", url: "https://buildingtools.co/r/McNQZz?click=t&type=0", x: 494.422, y: 1559.221, w: 137.32, h: 20 },
          { action: "back", x: 60, y: 2207, w: 142, h: 56 },
          { action: "next", x: 1198, y: 2207, w: 182, h: 56 }
        ]
      },
      // Slide 7 - Treasure Hunt
      {
        id: 7,
        file: "EDU Practical Guide (Implementation)/7 - Treasure Hunt.svg",
        viewBoxWidth: 1440,
        viewBoxHeight: 3243,
        overlays: [
          { action: "back", x: 101, y: 80, w: 50, h: 50 },
          { action: "next", x: 1293, y: 80, w: 50, h: 50 },
          { action: "url", url: "https://buildingtools.co/r/HlTJg5?click=t&type=0", x: 292, y: 496.719, w: 188, h: 20 },
          { action: "url", url: "https://buildingtools.co/r/TBSqx4?click=t&type=0", x: 288, y: 1342.800, w: 168, h: 20 },
          { action: "url", url: "https://buildingtools.co/r/SgRi8P?click=t&type=0", x: 484, y: 2194.459, w: 210, h: 20 },
          { action: "back", x: 60, y: 3127, w: 142, h: 56 },
          { action: "next", x: 1199, y: 3127, w: 181, h: 56 }
        ]
      },
      // Slide 8 - Discuss best Practices
      {
        id: 8,
        file: "EDU Practical Guide (Implementation)/8 - Discuss best Practices.svg",
        viewBoxWidth: 1440,
        viewBoxHeight: 3039,
        overlays: [
          { action: "back", x: 101, y: 80, w: 50, h: 50 },
          { action: "next", x: 1293, y: 80, w: 50, h: 50 },
          { action: "url", url: "https://buildingtools.co/r/31C7Di?click=t&type=0", x: 421.281, y: 530, w: 199.383, h: 20 },
          { action: "url", url: "https://buildingtools.co/r/Jo9Mbl?click=t&type=0", x: 757.906, y: 1324, w: 276.764, h: 20 },
          { action: "url", url: "https://buildingtools.co/r/8VOkqY?click=t&type=0", x: 223, y: 2111, w: 139, h: 20 },
          { action: "back", x: 60, y: 2923, w: 142, h: 56 },
          { action: "next", x: 1198, y: 2923, w: 182, h: 56 }
        ]
      },
      // Slide 9 - Student Presentation
      {
        id: 9,
        file: "EDU Practical Guide (Implementation)/9 - Student Presentation.svg",
        viewBoxWidth: 1440,
        viewBoxHeight: 1081,
        overlays: [
          { action: "back", x: 101, y: 80, w: 50, h: 50 },
          { action: "next", x: 1293, y: 80, w: 50, h: 50 },
          { action: "url", url: "https://swinburne.buildingtools.co/tools/site-works-pool-safety-fence-gate?v=1&menu_id=5-6&shareId=ch6ODI-1761100718604&zoom=2.1048519522998363&x=495.0831070206157&y=310.2727794476419", x: 118, y: 570, w: 45.094, h: 48 },
          { action: "url", url: "https://buildingtools.co/r/sJq2L6?click=t&type=0", x: 167.547, y: 598, w: 85.422, h: 20 },
          { action: "url", url: "https://buildingtools.co/r/sJq2L6?click=t&type=0", x: 934, y: 258, w: 42, h: 20 },
          { action: "url", url: "https://buildingtools.co/r/HVkThH?click=t&type=0", x: 261.875, y: 598, w: 89.867, h: 20 },
          { action: "back", x: 60, y: 965, w: 142, h: 56 },
          { action: "next", x: 1198, y: 965, w: 182, h: 56 }
        ]
      },
      // Slide 10 - SpecBlock Demo
      {
        id: 10,
        file: "EDU Practical Guide (Implementation)/10 - SpecBlock Demo.svg",
        viewBoxWidth: 1440,
        viewBoxHeight: 1019,
        overlays: [
          { action: "back", x: 101, y: 80, w: 50, h: 50 },
          { action: "next", x: 1293, y: 80, w: 50, h: 50 },
          { action: "url", url: "https://buildingtools.co/install-tools-revit-add-on/", x: 120, y: 405, w: 278, h: 20 },
          { action: "url", url: "https://buildingtools.co/install-tools-revit-add-on/", x: 80, y: 442, w: 432, h: 20 },
          { action: "back", x: 60, y: 903, w: 142, h: 56 },
          { action: "next", x: 1191, y: 903, w: 189, h: 56 }
        ]
      },
      // Slide 11 - Safety, Risk and Liability
      {
        id: 11,
        file: "EDU Practical Guide (Implementation)/11 - Safety, Risk and Liability.svg",
        viewBoxWidth: 1440,
        viewBoxHeight: 1269,
        overlays: [
          { action: "back", x: 101, y: 80, w: 50, h: 50 },
          { action: "next", x: 1293, y: 80, w: 50, h: 50 },
          { action: "url", url: "https://buildingtools.co/r/9cirGa?click=t&type=0", x: 205.203, y: 540, w: 142.594, h: 20 },
          { action: "url", url: "https://buildingtools.co/r/Q9hPDG?click=t&type=0", x: 210.164, y: 578, w: 116.969, h: 20 },
          { action: "url", url: "https://buildingtools.co/r/KwdAG2?click=t&type=0", x: 265.484, y: 616, w: 163.735, h: 20 },
          { action: "url", url: "https://buildingtools.co/r/6tgg0a?click=t&type=0", x: 400.75, y: 644, w: 36.469, h: 20 },
          { action: "url", url: "https://buildingtools.co/r/1h41LS?click=t&type=1", x: 382.391, y: 710, w: 72.078, h: 20 },
          { action: "back", x: 60, y: 1153, w: 142, h: 56 },
          { action: "next", x: 1193, y: 1153, w: 187, h: 56 }
        ]
      },
      // Slide 12 - Critical Thinking
      {
        id: 12,
        file: "EDU Practical Guide (Implementation)/12 - Critical Thinking.svg",
        viewBoxWidth: 1440,
        viewBoxHeight: 1391,
        overlays: [
          { action: "back", x: 101, y: 80, w: 50, h: 50 },
          { action: "next", x: 1293, y: 80, w: 50, h: 50 },
          { action: "back", x: 60, y: 1275, w: 142, h: 56 },
          { action: "next", x: 1156, y: 1275, w: 224, h: 56 }
        ]
      },
      // Slide 13 - All set
      {
        id: 13,
        file: "EDU Practical Guide (Implementation)/13 - All set.svg",
        viewBoxWidth: 1440,
        viewBoxHeight: 796,
        overlays: [
          { action: "back", x: 101, y: 80, w: 50, h: 50 },
          { action: "back", x: 60, y: 680, w: 142, h: 56 },
          { action: "url", url: "https://swinburne.buildingtools.co/", x: 619.016, y: 519, w: 203, h: 56 }
        ]
      }
    ];

    // DOM setup
    const container = document.querySelector('.container');

    const state = {
      index: 0, // 0..12
      loaded: new Array(components.length).fill(false),
      viewBox: new Array(components.length).fill(null), // {w,h}
      accordion: {} // per-slide accordion expanded state maps
    };

    function buildDOM() {
      components.forEach((c, i) => {
        const comp = document.createElement('div');
        comp.className = 'component' + (i === 0 ? ' active' : '');
        comp.dataset.idx = i;

        const host = document.createElement('div');
        host.className = 'svg-host';

        const img = document.createElement('img');
        img.src = c.file;
        img.setAttribute('aria-label', `Slide ${c.id}`);

        const overlays = document.createElement('div');
        overlays.className = 'overlay-root';

        host.appendChild(img);
        host.appendChild(overlays);  // Put overlays inside the svg-host
        comp.appendChild(host);
        container.appendChild(comp);

        // Use fixed viewBox dimensions from component config
        state.viewBox[i] = { w: c.viewBoxWidth || 1440, h: c.viewBoxHeight || 2500 };
        
        // Wait for image to load before rendering overlays
        img.addEventListener('load', () => {
          state.loaded[i] = true;
          // initialize accordion state for this slide
          if (c.accordions && !state.accordion[i]) {
            state.accordion[i] = {};
            c.accordions.forEach(acc => { state.accordion[i][acc.id] = false; });
          }
          renderOverlays(i);
        });
      });
    }

    function pct(n, d) { return (n / d) * 100; }

    function renderOverlays(idx) {
      const compEl = container.querySelector(`.component[data-idx="${idx}"]`);
      if (!compEl) return;
      const root = compEl.querySelector('.overlay-root');
      root.innerHTML = '';
      const vb = state.viewBox[idx];
      if (!vb) return; // wait until we know viewbox

      const showDebug = document.getElementById('debugToggle')?.checked || false;

      const host = compEl.querySelector('.svg-host');

      const current = components[idx];
      
      // Calculate dynamic height for accordion slides
      let dynamicHeight = vb.h;
      if (current.accordions) {
        // Calculate actual content height: header + accordions + post-image + footer
        const headerHeight = 170; // Space before accordions
        const footerHeight = 100; // Space for navigation buttons at bottom
        
        let accordionTotalHeight = 0;
        current.accordions.forEach((acc) => {
          const expanded = state.accordion[idx] && state.accordion[idx][acc.id];
          accordionTotalHeight += expanded ? acc.hE : acc.hC;
        });
        
        dynamicHeight = headerHeight + accordionTotalHeight + footerHeight;
        
        // Add post-accordion image height if present
        if (current.postAccordionImage) {
          dynamicHeight += 150 + current.postAccordionImage.height; // Add 150px spacing
        }
        
        // Update the component's viewBox height
        state.viewBox[idx].h = dynamicHeight;
        components[idx].viewBoxHeight = dynamicHeight;
      }

      // Cover middle content on slide 3 with background color
      if (idx === 2 && current.accordions) {
        const coverEl = document.createElement('div');
        coverEl.style.position = 'absolute';
        coverEl.style.left = '0';
        coverEl.style.top = '160px';
        coverEl.style.width = '100%';
        coverEl.style.height = '6000px'; // Cover everything in the middle
        coverEl.style.background = '#dbe5f1';
        coverEl.style.pointerEvents = 'none';
        coverEl.style.zIndex = '1';
        root.appendChild(coverEl);
      }

      // Render accordions (if any)
      if (current.accordions) {
        // Use only width-based scaling to prevent accordion size changes
        const hostRect = host.getBoundingClientRect();
        const scale = hostRect.width / vb.w; // Use same scale for both X and Y
        
        let offset = 0; // cumulative extra height from expanded items above
        current.accordions.forEach((acc) => {
          const expanded = state.accordion[idx] && state.accordion[idx][acc.id];
          const y = acc.y + offset;
          const h = expanded ? acc.hE : acc.hC;

          // Use <img> instead of <object> to avoid isolated document context
          const imgEl = document.createElement('img');
          imgEl.src = expanded ? acc.expanded : acc.collapsed;
          imgEl.style.position = 'absolute';
          imgEl.style.left = (60 * scale) + 'px';
          imgEl.style.top = (y * scale) + 'px';
          imgEl.style.width = (1320 * scale) + 'px';
          imgEl.style.height = (h * scale) + 'px';
          imgEl.style.pointerEvents = 'none';
          imgEl.style.zIndex = '10';
          imgEl.setAttribute('aria-label', acc.id);
          root.appendChild(imgEl);
          
          // Add click capture overlay for expanded accordions (Ctrl+Click to get coordinates)
          if (expanded) {
            const captureEl = document.createElement('div');
            captureEl.style.position = 'absolute';
            captureEl.style.left = (60 * scale) + 'px';
            captureEl.style.top = (y * scale) + 'px';
            captureEl.style.width = (1320 * scale) + 'px';
            captureEl.style.height = (h * scale) + 'px';
            captureEl.style.pointerEvents = 'none'; // Don't block clicks by default
            captureEl.style.zIndex = '13'; // Above links so we can capture Ctrl+clicks
            captureEl.style.background = 'transparent';
            // Listen on window for Ctrl key to enable pointer events
            const enableCapture = function(e) {
              if (e.ctrlKey || e.metaKey) {
                captureEl.style.pointerEvents = 'auto';
              }
            };
            const disableCapture = function() {
              captureEl.style.pointerEvents = 'none';
            };
            window.addEventListener('keydown', enableCapture);
            window.addEventListener('keyup', disableCapture);
            captureEl.addEventListener('click', function(e) {
              if (e.ctrlKey || e.metaKey) {
                e.preventDefault();
                e.stopPropagation();
                const rect = e.currentTarget.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const clickY = e.clientY - rect.top;
                const relativeX = clickX / scale;
                const relativeY = clickY / scale;
                console.log('=== ACCORDION LINK COORDINATE ===');
                console.log('Accordion: ' + acc.id);
                console.log('Relative X: ' + relativeX.toFixed(3));
                console.log('Relative Y: ' + relativeY.toFixed(3));
                console.log('Copy this: { url: "https://buildingtools.co/r/O8KA6i?click=t&type=0", x: ' + relativeX.toFixed(3) + ', y: ' + relativeY.toFixed(3) + ', w: 122.742, h: 18.3984 }');
                disableCapture();
              }
            });
            root.appendChild(captureEl);
          }

          // Add a toggle overlay: only cover the header bar (62px)
          const toggleEl = document.createElement('div');
          toggleEl.style.position = 'absolute';
          toggleEl.style.left = (60 * scale) + 'px';
          toggleEl.style.top = (y * scale) + 'px';
          toggleEl.style.width = (1320 * scale) + 'px';
          toggleEl.style.height = (62 * scale) + 'px'; // Only cover header, not content
          toggleEl.style.cursor = 'pointer';
          toggleEl.style.pointerEvents = 'auto';
          toggleEl.style.background = 'transparent';
          toggleEl.style.zIndex = '11';
          toggleEl.dataset.accordionId = acc.id; // For debugging
          if (showDebug) {
            toggleEl.style.background = 'rgba(255, 0, 0, 0.2)';
            toggleEl.style.border = '2px solid red';
          }
          toggleEl.addEventListener('click', ((accordionId, currentExpanded, accY) => {
            return (e) => {
              e.stopPropagation();
              const rect = e.currentTarget.getBoundingClientRect();
              const clickX = e.clientX - rect.left;
              const clickY = e.clientY - rect.top;
              const svgX = clickX / scale;
              const svgY = (rect.top + clickY - host.getBoundingClientRect().top) / scale;
              console.log('Clicked accordion:', accordionId, 'at overlay y:', accY, '| Click coords - SVG x:', svgX.toFixed(3), 'y:', svgY.toFixed(3), '| Screen x:', e.clientX, 'y:', e.clientY);
              if (!state.accordion[idx]) state.accordion[idx] = {};
              state.accordion[idx][accordionId] = !currentExpanded;
              renderOverlays(idx);
              // Notify parent of height change
              notifyParentHeight();
            };
          })(acc.id, expanded, y));
          root.appendChild(toggleEl);

          // Add clickable overlays for links inside accordion content when expanded
          if (expanded && acc.links) {
            acc.links.forEach((link) => {
              const linkEl = document.createElement('a');
              linkEl.href = link.url;
              linkEl.target = '_blank';
              linkEl.style.position = 'absolute';
              linkEl.style.left = ((60 + link.x) * scale) + 'px';
              linkEl.style.top = ((y + link.y) * scale) + 'px';
              linkEl.style.width = (link.w * scale) + 'px';
              linkEl.style.height = (link.h * scale) + 'px';
              linkEl.style.pointerEvents = 'auto';
              linkEl.style.cursor = 'pointer';
              linkEl.style.zIndex = '12';
              linkEl.style.display = 'block';
              if (showDebug) {
                linkEl.style.background = 'rgba(0, 255, 0, 0.2)';
                linkEl.style.border = '1px solid green';
              }
              root.appendChild(linkEl);
            });
          }

          // update offset for following accordions
          offset += (h - acc.hC);
        });
        
        // Render post-accordion image if present
        if (current.postAccordionImage) {
          const hostRect = host.getBoundingClientRect();
          const scale = hostRect.width / vb.w; // Use same width-based scale
          
          // Calculate Y position after all accordions (add 150px spacing)
          const accordionEndY = 170 + current.accordions.reduce((sum, acc) => {
            const expanded = state.accordion[idx] && state.accordion[idx][acc.id];
            return sum + (expanded ? acc.hE : acc.hC);
          }, 0) + 150;
          
          // Create img element for the SVG
          const imgEl = document.createElement('img');
          imgEl.src = current.postAccordionImage.file;
          imgEl.style.position = 'absolute';
          imgEl.style.left = (80 * scale) + 'px';
          imgEl.style.top = (accordionEndY * scale) + 'px';
          imgEl.style.width = (current.postAccordionImage.width * scale) + 'px';
          imgEl.style.height = (current.postAccordionImage.height * scale) + 'px';
          imgEl.style.pointerEvents = 'auto';
          imgEl.style.zIndex = '10';
          imgEl.setAttribute('aria-label', 'Additional content');
          root.appendChild(imgEl);
          
          // Add overlays for buttons in the post-accordion image
          if (current.postAccordionImage.overlays) {
            current.postAccordionImage.overlays.forEach((o) => {
              const btnEl = document.createElement('div');
              btnEl.className = 'click-area' + (showDebug ? ' debug' : '');
              btnEl.style.position = 'absolute';
              btnEl.style.left = (80 * scale + o.x * scale) + 'px';
              btnEl.style.top = (accordionEndY * scale + o.y * scale) + 'px';
              btnEl.style.width = (o.w * scale) + 'px';
              btnEl.style.height = (o.h * scale) + 'px';
              btnEl.style.pointerEvents = 'auto';
              btnEl.style.cursor = 'pointer';
              btnEl.style.zIndex = '20';
              btnEl.title = o.action.toUpperCase();
              btnEl.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                handleAction(o);
              });
              root.appendChild(btnEl);
            });
          }
        }
        
        // Add navigation buttons at the bottom for slide 3
        const navScale = host.getBoundingClientRect().width / vb.w;
        const navY = dynamicHeight - 70; // Position near bottom
        
        // Top navigation buttons
        const topBackBtn = document.createElement('div');
        topBackBtn.className = 'click-area' + (showDebug ? ' debug' : '');
        topBackBtn.style.position = 'absolute';
        topBackBtn.style.left = (101 / vb.w) * 100 + '%';
        topBackBtn.style.top = (80 / vb.h) * 100 + '%';
        topBackBtn.style.width = (50 / vb.w) * 100 + '%';
        topBackBtn.style.height = (50 / vb.h) * 100 + '%';
        topBackBtn.style.pointerEvents = 'auto';
        topBackBtn.style.cursor = 'pointer';
        topBackBtn.style.zIndex = '20';
        topBackBtn.title = 'BACK';
        topBackBtn.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); goTo(state.index - 1); });
        root.appendChild(topBackBtn);
        
        const topNextBtn = document.createElement('div');
        topNextBtn.className = 'click-area' + (showDebug ? ' debug' : '');
        topNextBtn.style.position = 'absolute';
        topNextBtn.style.left = (1293 / vb.w) * 100 + '%';
        topNextBtn.style.top = (80 / vb.h) * 100 + '%';
        topNextBtn.style.width = (50 / vb.w) * 100 + '%';
        topNextBtn.style.height = (50 / vb.h) * 100 + '%';
        topNextBtn.style.pointerEvents = 'auto';
        topNextBtn.style.cursor = 'pointer';
        topNextBtn.style.zIndex = '20';
        topNextBtn.title = 'NEXT';
        topNextBtn.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); goTo(state.index + 1); });
        root.appendChild(topNextBtn);
        
        // Bottom navigation buttons
        const bottomBackBtn = document.createElement('div');
        bottomBackBtn.className = 'click-area' + (showDebug ? ' debug' : '');
        bottomBackBtn.style.position = 'absolute';
        bottomBackBtn.style.left = (60 / vb.w) * 100 + '%';
        bottomBackBtn.style.top = (navY / vb.h) * 100 + '%';
        bottomBackBtn.style.width = (142 / vb.w) * 100 + '%';
        bottomBackBtn.style.height = (56 / vb.h) * 100 + '%';
        bottomBackBtn.style.pointerEvents = 'auto';
        bottomBackBtn.style.cursor = 'pointer';
        bottomBackBtn.style.zIndex = '20';
        bottomBackBtn.title = 'BACK';
        bottomBackBtn.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); goTo(state.index - 1); });
        root.appendChild(bottomBackBtn);
        
        const bottomNextBtn = document.createElement('div');
        bottomNextBtn.className = 'click-area' + (showDebug ? ' debug' : '');
        bottomNextBtn.style.position = 'absolute';
        bottomNextBtn.style.left = (1198 / vb.w) * 100 + '%';
        bottomNextBtn.style.top = (navY / vb.h) * 100 + '%';
        bottomNextBtn.style.width = (182 / vb.w) * 100 + '%';
        bottomNextBtn.style.height = (56 / vb.h) * 100 + '%';
        bottomNextBtn.style.pointerEvents = 'auto';
        bottomNextBtn.style.cursor = 'pointer';
        bottomNextBtn.style.zIndex = '20';
        bottomNextBtn.title = 'NEXT';
        bottomNextBtn.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); goTo(state.index + 1); });
        root.appendChild(bottomNextBtn);
      }
      
      // Render regular overlays (nav/buttons)
      if (current.overlays) {
        current.overlays.forEach((o, oi) => {
        // Handle GIF overlays differently
        if (o.action === 'gif') {
          const gifEl = document.createElement('img');
          gifEl.src = o.url;
          gifEl.style.position = 'absolute';
          gifEl.style.left = (o.x / vb.w) * 100 + '%';
          gifEl.style.top = (o.y / vb.h) * 100 + '%';
          gifEl.style.width = (o.w / vb.w) * 100 + '%';
          gifEl.style.height = (o.h / vb.h) * 100 + '%';
          gifEl.style.borderRadius = '32px';
          gifEl.style.objectFit = 'cover';
          gifEl.style.pointerEvents = 'none';
          root.appendChild(gifEl);
          return;
        }
        
        const el = document.createElement('div');
        el.className = 'click-area' + (showDebug ? ' debug' : '');
        
        // Convert SVG coordinates to percentage based on viewBox
        let leftPct = (o.x / vb.w) * 100;
        const topPct = (o.y / vb.h) * 100;
        let widthPct = (o.w / vb.w) * 100;
        const heightPct = (o.h / vb.h) * 100;
        
        el.style.left = leftPct + '%';
        el.style.top = topPct + '%';
        el.style.width = widthPct + '%';
        el.style.height = heightPct + '%';
        el.title = o.action.toUpperCase();

        el.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          handleAction(o);
        });

        root.appendChild(el);
        });
      }
    }

    function handleAction(o) {
      if (o.action === 'next') {
        goTo(state.index + 1, 'button');
      } else if (o.action === 'back') {
        goTo(state.index - 1, 'button');
      } else if (o.action === 'url' && o.url) {
        window.open(o.url, '_blank', 'noopener');
      } else if (o.action === 'goto' && Number.isInteger(o.to)) {
        goTo(o.to, 'button');
      } else {
        console.log('Unhandled action:', o);
      }
    }

    function goTo(newIndex, method = 'button') {
      const max = components.length - 1;
      const clamped = Math.max(0, Math.min(max, newIndex));
      if (clamped === state.index) return;
      
      const prevIndex = state.index;
      const prev = container.querySelector(`.component[data-idx="${state.index}"]`);
      const next = container.querySelector(`.component[data-idx="${clamped}"]`);
      if (prev) prev.classList.remove('active');
      if (next) next.classList.add('active');
      state.index = clamped;
      
      // Recalculate height for accordion slides before rendering
      if (components[clamped].accordions && state.accordion[clamped]) {
        const baseHeight = 170 + 5918 - 664;
        let accordionTotalHeight = 0;
        components[clamped].accordions.forEach((acc) => {
          const expanded = state.accordion[clamped] && state.accordion[clamped][acc.id];
          accordionTotalHeight += expanded ? acc.hE : acc.hC;
        });
        const dynamicHeight = baseHeight + accordionTotalHeight;
        state.viewBox[clamped].h = dynamicHeight;
        components[clamped].viewBoxHeight = dynamicHeight;
      }
      
      // ensure overlays re-render to honor debug toggle
      if (state.viewBox[clamped]) renderOverlays(clamped);
      
      // Notify parent window of new height
      notifyParentHeight();
      
      // Scroll parent window to top
      if (window.parent !== window) {
        window.parent.postMessage({ action: 'scrollToTop' }, '*');
      }
      // Also scroll this window to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    function getComponentName(index) {
      if (components[index]) {
        return components[index].name || `Slide ${components[index].id}`;
      }
      return `Step ${index + 1}`;
    }
    
    function notifyParentHeight() {
      if (window.parent !== window) {
        const currentHeight = components[state.index].viewBoxHeight;
        console.log('Sending height notification:', currentHeight);
        window.parent.postMessage({ 
          action: 'resizeIframe', 
          height: currentHeight 
        }, '*');
      }
    }

    function hookDebug() {
      const dbg = document.getElementById('debugToggle');
      const btn = document.getElementById('debugButton');
      const coordDisplay = document.getElementById('coordDisplay');
      
      btn.addEventListener('click', () => {
        dbg.checked = !dbg.checked;
        btn.textContent = dbg.checked ? 'Hide Click Areas' : 'Show Click Areas';
        btn.classList.toggle('active', dbg.checked);
        coordDisplay.classList.toggle('active', dbg.checked);
        // re-render overlays for current component
        if (state.viewBox[state.index]) renderOverlays(state.index);
      });
      
      dbg.addEventListener('change', () => {
        btn.textContent = dbg.checked ? 'Hide Click Areas' : 'Show Click Areas';
        btn.classList.toggle('active', dbg.checked);
        coordDisplay.classList.toggle('active', dbg.checked);
        // re-render overlays for current component
        if (state.viewBox[state.index]) renderOverlays(state.index);
      });
      
      // Add click coordinate tracking
      container.addEventListener('click', (e) => {
        if (!dbg.checked) return;
        
        const compEl = container.querySelector(`.component[data-idx="${state.index}"]`);
        if (!compEl) return;
        
        const host = compEl.querySelector('.svg-host');
        if (!host) return;
        
        const rect = host.getBoundingClientRect();
        const vb = state.viewBox[state.index];
        if (!vb) return;
        
        // Get click position relative to the SVG host
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        // Convert to SVG coordinates
        const svgX = (x / rect.width) * vb.w;
        const svgY = (y / rect.height) * vb.h;
        
        // Update display and copy to clipboard
        const coordText = `x: ${svgX.toFixed(3)}, y: ${svgY.toFixed(3)}`;
        coordDisplay.textContent = coordText;
        
        // Copy to clipboard
        navigator.clipboard.writeText(coordText).then(() => {
          coordDisplay.textContent = coordText + ' (copied!)';
          setTimeout(() => {
            coordDisplay.textContent = 'Click on slide to see coordinates';
          }, 2000);
        }).catch(() => {
          // Fallback if clipboard fails
          console.log('Coordinates:', coordText);
        });
        
        e.stopPropagation();
      });
    }

    function hookKeyboard() {
      document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
          e.preventDefault();
          goTo(state.index + 1, 'keyboard');
        } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
          e.preventDefault();
          goTo(state.index - 1, 'keyboard');
        }
      });
    }

    // init
    buildDOM();
    hookDebug();
    hookKeyboard();
    
    // Notify parent of initial height after DOM is ready
    window.addEventListener('load', () => {
      notifyParentHeight();
    });
  </script>
</body>
</html>
